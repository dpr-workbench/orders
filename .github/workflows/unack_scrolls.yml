name: Multi-Category Orders & Messages Report

on:
  schedule:
    # 3x daily at 4:30 AM, 4:30 PM, and 10:30 PM GMT
    - cron: "30 4 * * *" # 4:30 AM GMT
    - cron: "30 16 * * *" # 4:30 PM GMT
    - cron: "30 22 * * *" # 10:30 PM GMT
  workflow_dispatch:
    inputs:
      window_hours:
        description: "How many hours back to scan"
        default: "168"
        required: false

jobs:
  run-report:
    runs-on: ubuntu-latest
    concurrency:
      group: orders-messages-report
      cancel-in-progress: false

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          pip install -r bot/requirements.txt

      - name: Run report
        env:
          DISCORD_TOKEN: ${{ secrets.DISCORD_TOKEN }}
          DISCORD_GUILD_ID: ${{ secrets.DISCORD_GUILD_ID }}
          # Knobs
          WINDOW_HOURS: ${{ github.event.inputs.window_hours || '168' }}
          # Safety cap
          MAX_RESULTS: ${{ vars.MAX_RESULTS }}
        run: |
          python bot/report.py
